<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin CMS | Zaidly</title>
  <base href="/admin/" />
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>

<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <script>
    /* ===========================
       1. ASTRO IMAGE (MDX FIX)
       Solusi agar gambar muncul & tidak error build
    =========================== */
    CMS.registerEditorComponent({
      id: "astro_image",
      label: "Astro Image (MDX)",
      fields: [
        { name: "src", label: "Pilih Gambar", widget: "image" },
        { name: "alt", label: "Alt Text (SEO)", widget: "string" }
      ],
      // Regex untuk mendeteksi kembali komponen saat edit artikel
      pattern: /^<Image src=\{import\("(.*?)"\)\} alt="(.*?)" \/>$/,
      fromBlock: function(match) {
        return { src: match[1], alt: match[2] };
      },
      toBlock: function(obj) {
        // Otomatis ubah path /src/assets/ ke ../../assets/ agar dibaca Astro
        let cleanPath = obj.src;
        if (cleanPath.startsWith('/src/')) {
          cleanPath = `../../${cleanPath.replace('/src/', '')}`;
        }
        // Wajib satu baris lurus agar Cloudflare build tidak error
        return `<Image src={import("${cleanPath}")} alt="${obj.alt}" />`;
      },
      toPreview: function(obj) {
        return `<img src="${obj.src}" alt="${obj.alt}" style="max-width:100%; height:auto; border-radius:8px;" />`;
      }
    });

    /* ===========================
       2. AFFILIATE BUTTONS
       Sesuai spesifikasi Zaidly.com
    =========================== */
    CMS.registerEditorComponent({
      id: "affiliate_group",
      label: "Affiliate Buttons (Pair)",
      fields: [
        { name: "amazon_url", label: "Amazon Link", widget: "string" },
        { name: "ali_url", label: "AliExpress Link", widget: "string" }
      ],
      // Deteksi pola div affiliate
      pattern: /^<div class="flex flex-wrap gap-3 my-4">[\s\S]*?href="(.*?)" merchant="Amazon"[\s\S]*?href="(.*?)" merchant="AliExpress"[\s\S]*?<\/div>$/,
      fromBlock: function(match) {
        return { amazon_url: match[1], ali_url: match[2] };
      },
      toBlock: function(obj) {
        return `<div class="flex flex-wrap gap-3 my-4">
  <AffiliateLink href="${obj.amazon_url || '#'}" merchant="Amazon" />
  <AffiliateLink href="${obj.ali_url || '#'}" merchant="AliExpress" />
</div>`;
      },
      toPreview: function(obj) {
        return `<div style="padding:10px; background:#f9f9f9; border:1px dashed #ccc; text-align:center; border-radius:5px;">
          <strong>Affiliate Buttons:</strong><br/>
          <small>Amazon: ${obj.amazon_url} | AliExpress: ${obj.ali_url}</small>
        </div>`;
      }
    });
  </script>
</body>
</html>