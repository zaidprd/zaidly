<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin CMS | Zaidly</title>
  <base href="/admin/" />
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>

<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <script>
    /* ===========================
       1. ASTRO IMAGE (MDX FIX)
       Edit: Ditambahkan fix agar preview gambar muncul di CMS
    =========================== */
    CMS.registerEditorComponent({
      id: "astro_image",
      label: "Astro Image (MDX)",
      fields: [
        { name: "src", label: "Pilih Gambar", widget: "image" },
        { name: "alt", label: "Alt Text (SEO)", widget: "string" }
      ],
      // Deteksi pola import MDX
      pattern: /^<Image src=\{import\("(.*?)"\)\} alt="(.*?)" \/>$/,
      fromBlock: function(match) {
        // Membersihkan path relatif saat masuk kembali ke editor
        let cleanSrc = match[1].replace('../../assets/images/blog/', '/src/assets/images/blog/');
        return { src: cleanSrc, alt: match[2] };
      },
      toBlock: function(obj) {
        let path = obj.src;
        // Ubah path absolut /src/ menjadi relatif ../../ untuk Astro
        if (path.startsWith('/src/')) {
          path = `../../${path.replace('/src/', '')}`;
        }
        // JANGAN DIUBAH: Ini format wajib MDX Astro
        return `<Image src={import("${path}")} alt="${obj.alt}" />`;
      },
      toPreview: function(obj) {
        // FIX: Agar gambar muncul di kotak preview sebelah kanan CMS
        // Kita gunakan path asli yang dipilih oleh widget image
        return `<img src="${obj.src}" alt="${obj.alt}" style="width:100%; height:auto; border-radius:12px; border: 2px solid #eee; margin-top: 10px;" />`;
      }
    });

    /* ===========================
       2. AFFILIATE BUTTONS
       =========================== */
    CMS.registerEditorComponent({
      id: "affiliate_group",
      label: "Affiliate Buttons (Pair)",
      fields: [
        { name: "amazon_url", label: "Amazon Link", widget: "string" },
        { name: "ali_url", label: "AliExpress Link", widget: "string" }
      ],
      pattern: /^<div class="flex flex-wrap gap-3 my-4">[\s\S]*?href="(.*?)" merchant="Amazon"[\s\S]*?href="(.*?)" merchant="AliExpress"[\s\S]*?<\/div>$/,
      fromBlock: function(match) {
        return { amazon_url: match[1], ali_url: match[2] };
      },
      toBlock: function(obj) {
        // Format satu baris agar MDX tidak bingung dengan spasi kosong
        return `<div class="flex flex-wrap gap-3 my-4"><AffiliateLink href="${obj.amazon_url || '#'}" merchant="Amazon" /><AffiliateLink href="${obj.ali_url || '#'}" merchant="AliExpress" /></div>`;
      },
      toPreview: function(obj) {
        return `
          <div style="padding:15px; background:#f4f1ea; border:1px solid #d4cdc1; text-align:center; border-radius:8px; margin: 10px 0;">
            <p style="margin:0 0 10px 0; font-weight:bold; color:#4a3728;">ðŸ›’ Affiliate Buttons Preview</p>
            <span style="background:#232f3e; color:white; padding:5px 10px; border-radius:4px; font-size:10px; margin-right:5px;">Amazon</span>
            <span style="background:#ff4747; color:white; padding:5px 10px; border-radius:4px; font-size:10px;">AliExpress</span>
          </div>`;
      }
    });
  </script>
</body>
</html>