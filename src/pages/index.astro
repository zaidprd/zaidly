---
// src/pages/index.astro
export const prerender = true;

import MainLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/Hero.astro'; 
import WhoIsZaidly from '../components/section/WhoIsZaidly.astro'; 
import FeaturedCategories from '../components/section/FeaturedCategories.astro';
import TopPicks from '../components/section/TopPicks.astro'; 
import CoffeeGearHub from '../components/section/CoffeeGearHub.astro'; 
import LatestPosts from '../components/section/LatestArticles.astro'; 
import CoffeeBeanGuides from '../components/section/CoffeeBeanGuides.astro';
import { getCollection } from 'astro:content';
import { getTursoPosts } from '../lib/turso';

// 1. AMBIL DATA LOKAL (.md / .mdx)
const allLocalPosts = await getCollection('blog') || []; 
const now = new Date().getTime();

const publishedLocal = allLocalPosts.filter((post) => {
    const isNotDraft = (post.data as any).draft !== true;
    const postTime = new Date(post.data.pubDate).getTime();
    return isNotDraft && postTime <= now;
}).map(post => {
    // FIX: Buang ekstensi .md dari slug
    const cleanSlug = (post.id || post.slug).replace(/\.(md|mdx)$/, '');
    
    return {
        // FLAT DATA: Keluarkan semua dari post.data ke level atas
        ...post.data, 
        title: post.data.title,      // Pastikan title ada di sini
        description: post.data.description,
        image: post.data.image,      // Pastikan image ada di sini
        category: post.data.category,
        slug: cleanSlug,
        isExternal: false,
        pubDate: post.data.pubDate
    };
});

// 2. AMBIL DATA TURSO
let tursoPosts: any[] = [];
try {
    const rawTurso = await getTursoPosts() as any[];
    tursoPosts = rawTurso.map((p: any) => ({
        ...p,
        isExternal: true,
        // Gunakan mapping field yang konsisten
        pubDate: p.published_at || p.created_at || p.pubDate || new Date().toISOString(),
        image: p.r2_image_url || p.image // Ambil link R2
    }));
} catch (e) {
    console.error("Gagal ambil data Turso di Index:", e);
}

// 3. GABUNGKAN DAN URUTKAN
const allCombinedPosts = [...publishedLocal, ...tursoPosts].sort((a: any, b: any) => {
    const dateA = new Date(a.pubDate || 0).getTime();
    const dateB = new Date(b.pubDate || 0).getTime();
    return dateB - dateA;
});

// 4. PEMBAGIAN SECTION
const latestPosts = allCombinedPosts.slice(0, 3);
const gearPosts = allCombinedPosts.filter(p => p.category === 'gear-lab' || p.category === 'buying-guides').slice(0, 4);
const beanPosts = allCombinedPosts.filter(p => p.category === 'bean-roastery').slice(0, 4);

const featuredCategories = [
    { title: "Gear Guides", description: "In-depth reviews.", url: "/gear", icon: "ri:tools-line" },
    { title: "Bean Types", description: "Discover origins.", url: "/beans", icon: "ri:seedling-line" },
    { title: "Brew Methods", description: "Master techniques.", url: "/guides", icon: "ri:cup-line" },
    { title: "Café Culture", description: "Trends and stories.", url: "/blog", icon: "ri:store-line" },
];
---

<MainLayout title="Zaidly | Premium Coffee Gear Reviews">
    <Hero 
        title="Premium Coffee Gear for Home Brewing" 
        subtitle="Elevate your daily ritual with expert reviews."
        linkText="Explore Gear Reviews"
        linkUrl="/gear" 
        imageAlt="Collection of premium coffee brewing tools - Zaidly"
    />

    <FeaturedCategories categories={featuredCategories} />
    <TopPicks />

    <WhoIsZaidly 
        title="Independent Coffee Authority" 
        subtitle="Zaidly is a dedicated coffee gear guide."
        linkText="Our Review Process →"
        linkUrl="/about" 
    />
    
    {gearPosts.length > 0 && <CoffeeGearHub posts={gearPosts} />}
    
    {beanPosts.length > 0 && <CoffeeBeanGuides posts={beanPosts} />}
    
    {latestPosts.length > 0 && <LatestPosts posts={latestPosts} />}
</MainLayout>