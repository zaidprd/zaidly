---
export const prerender = false;

import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import PostCard from '../../../components/PostCard.astro';

const { category } = Astro.params;
const now = new Date().getTime();

// 1. AMBIL SEMUA ARTIKEL UNTUK GENERATE TABS [cite: 2026-01-09, 2026-01-10]
const allLocalForTabs = await getCollection('blog');
const localPostData = allLocalForTabs.map(p => ({ category: p.data.category }));

let payloadPostData = [];
try {
    const res = await fetch(`http://127.0.0.1:3000/api/posts?where[status][equals]=published&limit=100`);
    const data = await res.json();
    payloadPostData = (data.docs || []).map((p: any) => ({ category: p.category }));
} catch (e) { console.error(e); }

// Gabungkan semua kategori yang ada untuk dijadikan TABS [cite: 2026-01-10]
const allCategories = ['all', ...new Set([...localPostData, ...payloadPostData].map(p => p.category).filter(Boolean))];

// 2. FILTER ARTIKEL KHUSUS KATEGORI INI [cite: 2026-01-09]
const filteredLocal = allLocalForTabs
    .filter((post) => post.data.category === category)
    .filter((post) => {
        const isNotDraft = (post.data as any).draft !== true;
        return isNotDraft && new Date(post.data.pubDate).getTime() <= now;
    })
    .map(post => ({
        title: post.data.title,
        description: post.data.description,
        pubDate: post.data.pubDate,
        category: post.data.category,
        slug: post.slug,
        image: post.data.image,
        isPayload: false
    }));

let filteredPayload = [];
try {
    const res = await fetch(`http://127.0.0.1:3000/api/posts?where[category][equals]=${category}&where[status][equals]=published`);
    const data = await res.json();
    filteredPayload = (data.docs || []).map((post: any) => ({
        title: post.title,
        description: post.description,
        pubDate: new Date(post.pubDate),
        category: post.category,
        slug: post.slug,
        image: post.featuredImage?.url ? `http://127.0.0.1:3000${post.featuredImage.url}` : undefined,
        isPayload: true
    }));
} catch (e) { console.error(e); }

const allPosts = [...filteredLocal, ...filteredPayload].sort((a, b) => 
    new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime()
);

const categoryName = category ? category.replace('-', ' ') : 'Category';
---

<BaseLayout title={`${categoryName} - Zaidly Blog`}>
  <main class="bg-cream-latte/30 min-h-screen pt-32 pb-20">
    <div class="container mx-auto max-w-6xl px-4">
      
      <nav class="flex flex-wrap justify-center gap-3 mb-16 border-b border-coffee-brown/10 pb-12" aria-label="Blog categories">
        {allCategories.map((cat) => (
            <a 
                href={cat === 'all' ? '/blog' : `/blog/category/${cat}`}
                class:list={[
                    "text-[10px] font-black uppercase tracking-[0.2em] px-6 py-3 border transition-all duration-300 bg-white shadow-sm hover:shadow-md",
                    cat === category ? "border-coffee-dark text-coffee-dark bg-slate-50" : "border-coffee-dark/10 text-coffee-brown hover:border-accent-primary hover:text-accent-primary"
                ]}
            >
                {cat.replace('-', ' ')}
            </a>
        ))}
      </nav>

      <header class="mb-12 border-b-2 border-coffee-dark pb-6">
        <h1 class="text-5xl font-black uppercase italic text-coffee-dark">
          {categoryName}
        </h1>
        <p class="text-coffee-brown mt-2 text-sm uppercase tracking-widest font-bold">
          {allPosts.length} Articles Found
        </p>
      </header>

      {allPosts.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
          {allPosts.map(post => (
            <PostCard post={post} />
          ))}
        </div>
      ) : (
        <div class="text-center py-20 bg-white/50 border-2 border-dashed border-coffee-brown/20">
          <p class="text-coffee-brown italic">New articles for this category are being brewed. Check back soon!</p>
        </div>
      )}
    </div>
  </main>
</BaseLayout>