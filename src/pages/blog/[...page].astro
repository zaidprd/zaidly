---
// src/pages/blog/[...page].astro
export const prerender = true; // WAJIB TRUE!

import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import { getCollection } from "astro:content";
import { getTursoPosts } from '../../lib/turso';

export async function getStaticPaths({ paginate }: any) {
  // 1. Ambil data lokal (.md)
  const localPosts = (await getCollection("blog")).map(p => ({
    ...p.data,
    slug: p.id || p.slug,
    isExternal: false,
  }));

  // 2. Ambil data Turso
  let tursoPosts = [];
  try {
    tursoPosts = await getTursoPosts();
  } catch (e) {
    console.error("Turso build error:", e);
  }

  // 3. Gabungkan dan Urutkan
  const allPosts = [...localPosts, ...tursoPosts].sort(
    (a, b) => new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime()
  );

  // 4. Generate Pagination (9 post per halaman)
  return paginate(allPosts, { pageSize: 9 });
}

// Data 'page' didapat otomatis dari Astro.props hasil paginate()
const { page } = Astro.props;
---

<BaseLayout title={`Blog Page ${page.currentPage} | Zaidly`}>
  <section class="max-w-7xl mx-auto px-4 py-12">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      {page.data.map((post: any) => (
        <PostCard post={post} />
      ))}
    </div>

    <div class="flex justify-center gap-4 mt-12">
      {page.url.prev ? <a href={page.url.prev} class="p-2 border rounded">Prev</a> : null}
      <span class="p-2">Page {page.currentPage} of {page.lastPage}</span>
      {page.url.next ? <a href={page.url.next} class="p-2 border rounded">Next</a> : null}
    </div>
  </section>
</BaseLayout>
