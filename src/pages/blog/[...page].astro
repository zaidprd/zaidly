---
import { getCollection } from "astro:content";

// Path komponen (Asumsi: dari src/pages/blog/)
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import CategoryFilter from '../../components/CategoryFilter.astro';
import HeroBlog from '../../components/HeroBlog.astro';

import type { GetStaticPaths } from 'astro';
import type { CollectionEntry } from 'astro:content';
import type { Page } from 'astro'; 

type PostCollectionName = 'blog' | 'guides' | 'picks';
type CombinedPost = CollectionEntry<PostCollectionName>;


// =====================================
// STATIC PATHS (GETSTATICPATHS)
// =====================================
export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
    
    // POSTS_PER_PAGE di dalam scope untuk mencegah ReferenceError
    const POSTS_PER_PAGE = 9; 

    // 1. PENGAMBILAN DATA
    const blogPosts = await getCollection("blog");
    const guidePosts = await getCollection("guides");
    const bestPicksPosts = await getCollection("picks");

    let allPosts: CombinedPost[] = [...blogPosts, ...guidePosts, ...bestPicksPosts];

    // 2. PENGURUTAN DATA
    allPosts.sort((a, b) => {
        const aDate = a.data.pubDate ? a.data.pubDate.getTime() : 0;
        const bDate = b.data.pubDate ? b.data.pubDate.getTime() : 0;
        return bDate - aDate;
    });

    // 3. PAGINATION
    return paginate(allPosts, {
        pageSize: POSTS_PER_PAGE,
    });
};


// =====================================
// PROPS
// =====================================
const { page } = Astro.props as { page: Page<CombinedPost> }; 

// Ambil data yang dibutuhkan dari objek 'page'
const pageNum = page.currentPage;
const posts = page.data;
const nextUrl = page.url.next;

// --- KOREKSI TITLE DI SINI ---
const baseTitle = 'Blog'; // Anda bisa sesuaikan ini
const pageTitle = pageNum === 1 
    ? baseTitle 
    : `${baseTitle} - Page ${pageNum}`;

// Kita bisa juga membuat title hanya 'Blog' untuk page 1
// const pageTitle = pageNum === 1 
//    ? 'Blog' 
//    : `Blog - Page ${pageNum}`;
// Sesuaikan dengan kebutuhan Anda!
---

<BaseLayout title={pageTitle}> <HeroBlog />

  <div class="container mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 py-10">
    
    <div class="mb-10">
      <CategoryFilter />
    </div>

    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
      {posts.map((post: CombinedPost) => (
        <PostCard post={post} postType={post.collection} />
      ))}
    </section>

    {/* Menggunakan nextUrl yang otomatis dihasilkan oleh paginate */}
    {nextUrl && (
      <div class="text-center mt-12">
        <a
          href={nextUrl}
          class="inline-block bg-accent-primary text-white font-semibold px-10 py-3 rounded-lg shadow-lg hover:bg-coffee-dark transition duration-300"
        >
          Load More Articles
        </a>
      </div>
    )}

  </div>
</BaseLayout>