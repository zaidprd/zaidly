---
export const prerender = false;
import { getCollection } from "astro:content";
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import HeroBlog from '../../components/HeroBlog.astro';

// 1. KONFIGURASI URL RENDER [cite: 2026-01-10]
const PAYLOAD_URL = 'https://zaidlycms.onrender.com';

const { page: pageParam } = Astro.params;
const currentPage = pageParam ? parseInt(pageParam) : 1;
const pageSize = 9;

// 2. AMBIL ARTIKEL LOKAL [cite: 2026-01-10]
const blogPosts = await getCollection("blog");
const localPosts = blogPosts.map(post => ({
    title: post.data.title,
    category: post.data.category,
    pubDate: post.data.pubDate,
    description: post.data.description,
    slug: post.slug,
    image: post.data.image,
    isPayload: false
}));

// 3. AMBIL ARTIKEL PAYLOAD (FIXED QUERY & STATUS) [cite: 2026-01-10]
let payloadPosts = [];
try {
    // FIX: Gunakan _status (pakai garis bawah) dan draft=false sesuai log Render abang [cite: 2026-01-10]
    const res = await fetch(`${PAYLOAD_URL}/api/posts?where[_status][equals]=published&limit=100&sort=-pubDate&draft=false`);
    const data = await res.json();
    
    payloadPosts = (data.docs || []).map((post: any) => ({
        title: post.title,
        category: post.category,
        pubDate: new Date(post.pubDate),
        description: post.description,
        slug: post.slug,
        // Pastikan URL gambar absolut agar muncul di Cloudflare [cite: 2026-01-10]
        image: post.featuredImage?.url ? `${PAYLOAD_URL}${post.featuredImage.url}` : undefined,
        isPayload: true
    }));
} catch (e) { 
    console.error("Gagal ambil data Payload di Blog:", e); 
}

// 4. GABUNGKAN DAN URUTKAN BERDASARKAN TANGGAL [cite: 2026-01-10]
const allCombinedPosts = [...localPosts, ...payloadPosts].sort((a, b) => 
    new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime()
);

// 5. LOGIKA PAGINATION
const totalPages = Math.ceil(allCombinedPosts.length / pageSize);
const posts = allCombinedPosts.slice((currentPage - 1) * pageSize, currentPage * pageSize);

// GENERATE DAFTAR KATEGORI
const allCategories = ['all', ...new Set(allCombinedPosts.map((post) => post.category).filter(Boolean))];
---

<BaseLayout title="Blog | Zaidly"> 
    {currentPage === 1 && <HeroBlog />}
    
    <main class="bg-cream-latte/30 min-h-screen">
        <div class="container mx-auto max-w-6xl px-4 py-12">
            
            <nav class="flex flex-wrap justify-center gap-3 mb-16 border-b border-coffee-brown/10 pb-12">
                {allCategories.map((cat) => (
                    <a 
                        href={cat === 'all' ? '/blog' : `/blog/category/${cat}`}
                        class="text-[10px] font-black uppercase tracking-[0.2em] px-6 py-3 border border-coffee-dark/10 bg-white text-coffee-brown hover:border-accent-primary hover:text-accent-primary transition-all shadow-sm"
                    >
                        {cat.replace('-', ' ')}
                    </a>
                ))}
            </nav>

            <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-16">
                {posts.map((post) => (
                    /* PENTING: Pastikan komponen PostCard abang menerima data 
                       isPayload agar dia bisa buat link yang benar (tanpa /blog/)
                    */
                    <PostCard post={post} />
                ))}
            </section>

            <div class="mt-24 border-t border-coffee-brown/10 pt-16 flex justify-between items-center">
                {currentPage > 1 ? (
                    <a href={currentPage === 2 ? "/blog" : `/blog/${currentPage - 1}`} class="group flex flex-col items-start gap-4">
                        <span class="text-[11px] font-black uppercase tracking-[0.4em] text-coffee-brown group-hover:text-accent-primary transition-colors">
                            ← Previous Page
                        </span>
                        <div class="w-12 h-[1px] bg-coffee-dark group-hover:w-24 group-hover:bg-accent-primary transition-all duration-500"></div>
                    </a>
                ) : <div />}

                {currentPage < totalPages ? (
                    <a href={`/blog/${currentPage + 1}`} class="group flex flex-col items-end gap-4">
                        <span class="text-[11px] font-black uppercase tracking-[0.4em] text-coffee-brown group-hover:text-accent-primary transition-colors">
                            Next Page →
                        </span>
                        <div class="w-12 h-[1px] bg-coffee-dark group-hover:w-24 group-hover:bg-accent-primary transition-all duration-500"></div>
                    </a>
                ) : <div />}
            </div>
        </div>
    </main>
</BaseLayout>