---
// src/pages/blog/[...page].astro
import { getCollection } from "astro:content";

// Path komponen
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import HeroBlog from '../../components/HeroBlog.astro';

// Import Type Wajib
import type { GetStaticPaths, Page } from 'astro';
import type { CollectionEntry } from 'astro:content';

// Definisi Type
type PostCollectionName = 'blog'; 
type CombinedPost = CollectionEntry<PostCollectionName>;

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
    const POSTS_PER_PAGE = 9; 
    const blogPosts = await getCollection("blog");
    
    let allPosts: CombinedPost[] = [...blogPosts]; 

    allPosts.sort((a, b) => {
        const aDate = a.data.pubDate ? a.data.pubDate.getTime() : 0;
        const bDate = b.data.pubDate ? b.data.pubDate.getTime() : 0;
        return bDate - aDate;
    });

    return paginate(allPosts, {
        pageSize: POSTS_PER_PAGE,
    });
};

const { page } = Astro.props as { page: Page<CombinedPost> }; 

// Ambil semua kategori unik dari folder blog untuk menu filter
const allPostsForFilter = await getCollection("blog");
const categories = ['all', ...new Set(allPostsForFilter.map((post) => post.data.category))];

const pageNum = page.currentPage;
const posts = page.data;
const nextUrl = page.url.next;

const baseTitle = 'Journal'; // Nama lebih mewah dibanding 'Blog'
const pageTitle = pageNum === 1 ? baseTitle : `${baseTitle} - Page ${pageNum}`;
---

<BaseLayout title={pageTitle}> 
    
    {pageNum === 1 && (
        <HeroBlog />
    )}

    <div class="container mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 py-10">
        
        {/* 1. KATEGORI FILTER (MENU HORIZONTAL) */}
        <div class="flex flex-wrap justify-center gap-3 mb-16 border-b border-coffee-brown/10 pb-10">
            {categories.map((cat) => (
                <a 
                    href={cat === 'all' ? '/blog' : `/blog/category/${cat}`}
                    class="text-[10px] font-black uppercase tracking-[0.2em] px-6 py-3 border border-coffee-dark/10 hover:border-accent-primary hover:text-accent-primary transition-all duration-300 bg-white"
                >
                    {cat.replace('-', ' ')}
                </a>
            ))}
        </div>

        {/* 2. GRID ARTIKEL */}
        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10">
            {posts.map((post: CombinedPost) => (
                <PostCard post={post} postType={post.collection} /> 
            ))}
        </section>

        {/* 3. PAGINATION (FLAT STYLE) */}
        {nextUrl && (
            <div class="text-center mt-20">
                <a
                    href={nextUrl}
                    class="inline-block bg-coffee-dark text-white text-[11px] font-black uppercase tracking-[0.3em] px-12 py-5 hover:bg-accent-primary transition-colors duration-300"
                >
                    Load More Articles
                </a>
            </div>
        )}

    </div>
</BaseLayout>