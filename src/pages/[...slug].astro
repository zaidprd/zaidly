---
// ===============================================
// FILE: src/pages/[...slug].astro (FINAL VERSION)
// FIX: Menghilangkan prefix 'blog/' dari URL dan mengelola slug yang dikecualikan
// ===============================================

// 1. IMPOR WAJIB DARI ASTRO CONTENT COLLECTIONS
import { getCollection } from "astro:content"; 
import type { CollectionEntry } from 'astro:content'; 

// 2. IMPOR KOMPONEN DAN LAYOUT
import BaseLayout from '../layouts/BaseLayout.astro';
import ArticleLayout from '../layouts/ArticleLayout.astro'; 
import Error404 from '../components/Error404.astro'; 

// Definisi Tipe HANYA untuk blog
type BlogPost = CollectionEntry<'blog'>;

// --- Bagian 1: getStaticPaths (Menangani Routing) ---

export async function getStaticPaths() {
    // Ambil data HANYA dari koleksi 'blog'
    const allPosts = await getCollection('blog');
    
    // âœ¨ FIX: Tambahkan 'keystatic' ke daftar ini biar rute admin gak ditabrak!
    const excludedSlugs = ['admin', 'blog', 'about', 'gear', 'index', 'keystatic'];

    const paths = allPosts
        // Filter tetap sama
        .filter(post => !excludedSlugs.includes(post.slug)) 
        .map((post) => ({
            params: { 
                slug: post.slug.replace('blog/', ''), 
            }, 
            props: { post },
        }));

    return paths;
}

// --- Bagian 2: PROPS & DATA Halaman Dinamis ---

const { post } = Astro.props as { post: BlogPost }; 

// Deklarasi variabel dengan tipe aman (untuk menghindari error 'Content is not a valid component')
let Content: any = () => null; 
let headings: any[] = [];
let postData: any = {};

// Hanya render dan ambil data jika 'post' ada
if (post) { 
    // Mengambil Content dan Headings dengan aman
    const rendered = await post.render();
    Content = rendered.Content; 
    headings = rendered.headings;
    postData = post.data;
}

// --- END OF FRONTMATTER ---
---

{/* Tampilan Artikel atau 404 */}
{post ? (
    <ArticleLayout frontmatter={postData} headings={headings}> 
        <Content />
    </ArticleLayout>
) : (
    <BaseLayout title="404 Not Found">
        <Error404 /> 
    </BaseLayout>
)}