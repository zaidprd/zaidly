---
export const prerender = true;
import { getCollection, render } from 'astro:content'; 
import ArticleLayout from '../layouts/ArticleLayout.astro';
import { getTursoPosts } from '../lib/turso';
// 1. IMPORT MARKED UNTUK NERJEMAHIN MARKDOWN
import { marked } from 'marked';

export async function getStaticPaths() {
    const localPosts = await getCollection('blog');
    const localPaths = localPosts.map(post => ({
        params: { 
            slug: (post.slug || post.id).replace(/\.(md|mdx)$/, '') 
        }, 
        props: { post, isExternal: false }
    }));

    let tursoPosts: any[] = []; 
    try {
        tursoPosts = await getTursoPosts();
    } catch (e) {
        console.error("Turso error:", e);
    }
    
    const tursoPaths = tursoPosts.map(post => ({
        params: { slug: String(post.slug).trim() },
        props: { post, isExternal: true }
    }));

    return [...localPaths, ...tursoPaths];
}

const { post, isExternal } = Astro.props;
if (!post) return Astro.redirect('/404');

let finalFrontmatter;
let DynamicContent: any = null; 
let allHeadings: any[] = []; 
let htmlContent = ''; // Wadah untuk konten Sanity

if (isExternal) {
    finalFrontmatter = {
        title: post.title,
        description: post.description || '',
        image: post.image, // Menggunakan r2_image_url dari turso.ts
        author: post.author || 'Zaidly Team',
        pubDate: post.pubDate,
        isExternal: true
    };
    
    // 2. PROSES MARKDOWN MENJADI HTML
    // post.content_html sekarang isinya teks mentah Markdown
    htmlContent = await marked.parse(post.content_html || '');
} else {
    finalFrontmatter = {
        ...post.data,
        isExternal: false
    };
    const rendered = await render(post);
    DynamicContent = rendered.Content; 
    allHeadings = rendered.headings; 
}
---

<ArticleLayout frontmatter={finalFrontmatter as any} headings={allHeadings}>
    {/* CONTAINER PUTIH BERSIH - STYLE BEANHUB */}
    <div class="bg-white p-6 md:p-12 rounded-[2rem] shadow-sm border border-slate-100 min-h-[500px] my-8">
        <div class="prose prose-coffee max-w-none 
                    prose-table:border-collapse prose-table:w-full
                    prose-th:border prose-th:border-slate-200 prose-th:p-4 prose-th:bg-slate-50
                    prose-td:border prose-td:border-slate-200 prose-td:p-4
                    prose-img:rounded-2xl prose-img:mx-auto">
            {isExternal ? (
                /* 3. TAMPILKAN HASIL MARKED */
                <article set:html={htmlContent} />
            ) : (
                /* Render Komponen untuk Lokal */
                DynamicContent && <DynamicContent />
            )}
        </div>
    </div>
</ArticleLayout>