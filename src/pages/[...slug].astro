---
export const prerender = true;
import { getCollection, render } from 'astro:content'; 
import ArticleLayout from '../layouts/ArticleLayout.astro';
import PortableVisualBlocks from '../components/PortableVisualBlocks.astro';
import { getTursoPosts } from '../lib/turso';

export async function getStaticPaths() {
    const localPosts = await getCollection('blog');
    const localPaths = localPosts.map(post => ({
        params: { slug: (post.slug || post.id).trim() }, 
        props: { post, isExternal: false }
    }));

    let tursoPosts: any[] = []; 
    try { tursoPosts = await getTursoPosts(); } catch (e) {}
    
    const tursoPaths = tursoPosts.map(post => ({
        params: { slug: String(post.slug || '').trim() },
        props: { post, isExternal: true }
    }));
    return [...localPaths, ...tursoPaths];
}

const { post, isExternal } = Astro.props;
if (!post) return new Response(null, { status: 404 });

let finalFrontmatter: any;
let DynamicContent: any = null;
let visualData: any = null;
let headings: any[] = [];

if (isExternal) {
    const featuredImage = post.r2_image_url;
    const featuredImageRef = post.sanity_ref || post.mainImage?.asset?._ref;
    
    finalFrontmatter = { 
        title: post.title, 
        image: featuredImage, 
        author: post.author || 'Admin',
        pubDate: post.published_at,
        isExternal: true 
    };

    visualData = typeof post.visual_content === 'string' ? JSON.parse(post.visual_content) : post.visual_content;

    // ðŸ”¥ FIX UTAMA: EKSTRAK HEADINGS DARI MARKDOWN PASTE
    headings = visualData.flatMap((block: any) => {
        if (block._type !== 'block') return [];

        const text = block.children?.map((c: any) => c.text).join('') || '';
        // Regex Global: Cari baris baru yang diawali ## atau ###
        const matches = [...text.matchAll(/^(#{2,3})\s+(.+)$/gm)];

        return matches.map(m => {
            const title = m[2].trim();
            return {
                depth: m[1].length,
                text: title,
                slug: title.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-')
            };
        });
    });

} else {
    // Artikel MD/MDX Lokal
    finalFrontmatter = { ...post.data, isExternal: false };
    const rendered = await render(post);
    DynamicContent = rendered.Content; 
    headings = rendered.headings;
}
---

<ArticleLayout frontmatter={finalFrontmatter} headings={headings}>
    
        <div class="prose max-w-none zaidly-content">
            {isExternal ? (
                <PortableVisualBlocks value={visualData} />
            ) : (
                <div class="local-article-fix">
                    {DynamicContent && <DynamicContent />}
                </div>
            )}
        </div>
    </div>
</ArticleLayout>