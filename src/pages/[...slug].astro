---
// ===============================================
// FILE: src/pages/[...slug].astro (REVISED FINAL)
// FIX: Menghilangkan error 404, mengaktifkan tombol affiliate, dan fix BeanHub integration
// ===============================================

// 1. WAJIB: Tambahkan ini agar halaman statis kembali muncul (Fix 404)
export const prerender = true; 

import { getCollection } from "astro:content"; 
import type { CollectionEntry } from 'astro:content'; 

// 2. IMPOR KOMPONEN DAN LAYOUT
import BaseLayout from '../layouts/BaseLayout.astro';
import ArticleLayout from '../layouts/ArticleLayout.astro'; 
import Error404 from '../components/Error404.astro'; 
// Impor file tombol affiliate lu
import AffiliateLink from '../components/AffiliateLink.astro'; 

type BlogPost = CollectionEntry<'blog'>;

// --- Bagian 1: getStaticPaths (Menangani Routing) ---
export async function getStaticPaths() {
    const allPosts = await getCollection('blog');
    const excludedSlugs = ['admin', 'blog', 'about', 'gear', 'index', 'keystatic'];

    const paths = allPosts
        .filter(post => !excludedSlugs.includes(post.slug)) 
        .map((post) => ({
            params: { 
                slug: post.slug.replace('blog/', ''), 
            }, 
            props: { post },
        }));

    return paths;
}

// --- Bagian 2: PROPS & DATA ---
const { post } = Astro.props as { post: BlogPost }; 

let Content: any = () => null; 
let headings: any[] = [];
let postData: any = {};

if (post) { 
    const rendered = await post.render();
    Content = rendered.Content; 
    headings = rendered.headings;
    postData = post.data;
}

// âœ¨ MAPPING KOMPONEN: Hubungkan tag dashboard ke file .astro lu
const components = {
  AffiliateLink: AffiliateLink,
};
---

{/* Tampilan Artikel atau 404 */}
{post ? (
    <ArticleLayout frontmatter={postData} headings={headings}> 
        {/* Sisipkan components di sini agar tombol Amazon muncul */}
        <Content components={components} />
    </ArticleLayout>
) : (
    <BaseLayout title="404 Not Found">
        <Error404 /> 
    </BaseLayout>
)}