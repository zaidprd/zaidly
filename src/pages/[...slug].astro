---
export const prerender = true;
import { getCollection, render } from 'astro:content'; 
import ArticleLayout from '../layouts/ArticleLayout.astro';
import PortableVisualBlocks from '../components/PortableVisualBlocks.astro';
import { getTursoPosts } from '../lib/turso';

export async function getStaticPaths() {
    const localPosts = await getCollection('blog');
    const localPaths = localPosts.map(post => ({
        params: { slug: (post.slug || post.id).trim() }, 
        props: { post, isExternal: false }
    }));

    let tursoPosts: any[] = []; 
    try { tursoPosts = await getTursoPosts(); } catch (e) {}
    
    const tursoPaths = tursoPosts.map(post => ({
        params: { slug: String(post.slug || '').trim() },
        props: { post, isExternal: true }
    }));
    return [...localPaths, ...tursoPaths];
}

const { post, isExternal } = Astro.props;
if (!post) return new Response(null, { status: 404 });

let finalFrontmatter: any;
let DynamicContent: any = null;
let visualData: any = null;
let headings: any[] = [];

if (isExternal) {
    const postTags = typeof post.tags === 'string' ? JSON.parse(post.tags) : (post.tags || []);
    finalFrontmatter = { 
        title: post.title, 
        image: post.r2_image_url, 
        author: post.author || 'Admin',
        pubDate: post.published_at,
        tags: postTags,
        slug: post.slug,
        rating: post.rating, 
        price: post.price,
        isExternal: true 
    };
    visualData = typeof post.visual_content === 'string' ? JSON.parse(post.visual_content) : post.visual_content;
    
    // --- FIX FINAL: LOGIKA HEADINGS (CAMPURAN RICH TEXT & MARKDOWN) ---
    headings = (visualData || []).flatMap((block: any) => {
        const rawText = block.children?.map((c: any) => c.text).join('') || '';
        
        // Fungsi standarisasi slug agar sinkron dengan renderer
        const getSlug = (str: string) => str.toLowerCase()
            .replace(/[^\w\s-]/g, '')
            .trim()
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-');

        // 1. Cek jika Heading asli Sanity (h1-h6)
        const isSanityHeading = /^h[1-6]$/.test(block.style || '');
        
        // 2. Cek jika manual Markdown (# ## ###)
        const markdownMatch = rawText.match(/^(#{1,6})\s+(.*)/m);

        if (isSanityHeading) {
            const depth = parseInt(block.style.replace('h', ''));
            return [{ depth, text: rawText, slug: getSlug(rawText) }];
        } else if (markdownMatch) {
            const depth = markdownMatch[1].length;
            const text = markdownMatch[2].trim();
            return [{ depth, text, slug: getSlug(text) }];
        }
        
        return [];
    });
} else {
    finalFrontmatter = { ...post.data, isExternal: false };
    const rendered = await render(post);
    DynamicContent = rendered.Content; 
    headings = rendered.headings;
}
---

<ArticleLayout frontmatter={finalFrontmatter} headings={headings}>
    <div class="prose max-w-none zaidly-content">
        {isExternal ? (
            <PortableVisualBlocks value={visualData} />
        ) : (
            <div class="local-article-fix">
                {DynamicContent && <DynamicContent />}
            </div>
        )}
    </div>
</ArticleLayout>