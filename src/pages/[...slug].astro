---
// src/pages/[...slug].astro
export const prerender = true; // WAJIB TRUE agar web tidak Error 1101

import { getCollection, render } from 'astro:content'; 
import { Image } from 'astro:assets'; 
import BaseLayout from '../layouts/BaseLayout.astro';
import ArticleLayout from '../layouts/ArticleLayout.astro';
import Error404 from '../components/Error404.astro';
import { getTursoPosts } from '../lib/turso';

/**
 * 1. DEFINISI FUNGSI PEMBERSIH URL (Paling Atas)
 * Menghilangkan .md, .mdx, spasi, dan buntut "md/mdx"
 */
const cleanSlug = (text: string) => {
    return text
        .toString()
        .toLowerCase()
        .trim()
        .replace(/\.mdx$/, '')
        .replace(/\.md$/, '')
        .replace(/\s+/g, '-')
        .replace(/[^\w-]+/g, '')
        .replace(/--+/g, '-')
        .replace(/-mdx$/, '')
        .replace(/-md$/, '');
};

/**
 * 2. GENERATE PATHS SAAT BUILD
 */
export async function getStaticPaths() {
    // Ambil Data Lokal (.md / .mdx)
    const localPosts = await getCollection('blog');
    const localPaths = localPosts.map(post => ({
        params: { slug: cleanSlug(post.id || post.slug) }, 
        props: { post, isExternal: false }
    }));

    // Ambil Data Turso
    let tursoPosts = [];
    try {
        tursoPosts = await getTursoPosts();
    } catch (e) {
        console.error("Gagal ambil Turso saat build paths:", e);
    }
    
    const tursoPaths = tursoPosts.map(post => ({
        params: { slug: cleanSlug(post.slug) },
        props: { post, isExternal: true }
    }));

    return [...localPaths, ...tursoPaths];
}

const { post, isExternal } = Astro.props;

let DynamicContent: any = null; 
let allHeadings: any[] = []; 

if (!isExternal) {
    // Render Markdown Lokal
    const rendered = await render(post);
    DynamicContent = rendered.Content; 
    allHeadings = rendered.headings; 
}

// Mapping data agar seragam untuk Layout
const finalFrontmatter = isExternal 
    ? {
        title: post.title,
        description: post.description,
        pubDate: post.pubDate,
        author: post.author || "Admin",
        image: post.image,
        isExternal: true 
    } 
    : {
        ...post.data,
        isExternal: false
    };
---

{finalFrontmatter ? (
    <ArticleLayout frontmatter={finalFrontmatter as any} headings={allHeadings}>
        {/* CONTAINER PUTIH BERSIH (BEANHUB STYLE) */}
        <div class="bg-white p-8 md:p-12 rounded-[2rem] shadow-sm border border-slate-100 min-h-[500px] my-8">
            
            {/* RENDER GAMBAR UTAMA */}
            {finalFrontmatter.image && (
                <div class="mb-10 overflow-hidden rounded-2xl border border-slate-100 shadow-sm bg-slate-50">
                    {isExternal ? (
                        <img 
                            src={finalFrontmatter.image} 
                            alt={finalFrontmatter.title} 
                            class="w-full h-auto object-cover max-h-[600px] block" 
                        />
                    ) : (
                        <Image 
                            src={finalFrontmatter.image as any} 
                            alt={finalFrontmatter.title} 
                            width={1200} 
                            height={675}
                            class="w-full h-auto object-cover max-h-[600px]" 
                        />
                    )}
                </div>
            )}
            
            {/* RENDER ISI KONTEN */}
            <div class="prose prose-coffee max-w-none">
                {isExternal ? (
                    /* RENDER HTML DARI TURSO */
                    <div set:html={post.body} />
                ) : (
                    /* RENDER MARKDOWN LOKAL */
                    DynamicContent && <DynamicContent />
                )}
            </div>
        </div>
    </ArticleLayout>
) : (
    <BaseLayout title="404 Not Found">
        <Error404 />
    </BaseLayout>
)}
