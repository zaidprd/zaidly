---
// src/pages/[...slug].astro
export const prerender = false;

import { getCollection, render } from 'astro:content'; 
import { Image } from 'astro:assets'; 
import BaseLayout from '../layouts/BaseLayout.astro';
import ArticleLayout from '../layouts/ArticleLayout.astro';
import Error404 from '../components/Error404.astro';
import { turso } from '../lib/turso';

const { slug } = Astro.params;

// 1. CARI DATA LOKAL (.md / .mdx)
const allLocalPosts = await getCollection('blog'); 
const localPost = allLocalPosts.find((p) => p.id === slug || p.slug === slug);

let postFromTurso = null;
let DynamicContent: any = null; 
let allHeadings: any[] = []; 

if (localPost) {
    // JIKA KETEMU DI LOKAL
    const rendered = await render(localPost);
    DynamicContent = rendered.Content; 
    allHeadings = rendered.headings; 
} else {
    // 2. JIKA TIDAK ADA DI LOKAL, CARI DI DATABASE TURSO
    try {
        const result = await turso.execute({
            sql: "SELECT * FROM posts WHERE slug = ?",
            args: [slug]
        });
        
        if (result.rows.length > 0) {
            postFromTurso = result.rows[0];
        }
    } catch (e) {
        console.error("Turso Database Error:", e);
    }
}

// 3. MAPPING DATA (Agar formatnya seragam untuk ArticleLayout)
const finalFrontmatter = postFromTurso 
    ? {
        title: String(postFromTurso.title || "Untitled"),
        description: String(postFromTurso.description || ""),
        pubDate: postFromTurso.published_at ? new Date(String(postFromTurso.published_at)) : new Date(),
        author: String(postFromTurso.author || "Admin"),
        image: postFromTurso.r2_image_url || null,
        isExternal: true 
    } 
    : (localPost && localPost.data) 
        ? {
            ...localPost.data,
            isExternal: false
        } 
        : null;
---

{finalFrontmatter ? (
    <ArticleLayout frontmatter={finalFrontmatter as any} headings={allHeadings}>
        {/* CONTAINER PUTIH BERSIH (BEANHUB STYLE) */}
        <div class="bg-white p-8 md:p-12 rounded-[2rem] shadow-sm border border-slate-100 min-h-[500px] my-8">
            
            {/* RENDER GAMBAR UTAMA */}
            {finalFrontmatter.image && (
                <div class="mb-10 overflow-hidden rounded-2xl border border-slate-100 shadow-sm bg-slate-50">
                    {finalFrontmatter.isExternal ? (
                        <img 
                            src={finalFrontmatter.image} 
                            alt={finalFrontmatter.title} 
                            class="w-full h-auto object-cover max-h-[600px] block" 
                            loading="eager"
                        />
                    ) : (
                        <Image 
                            src={finalFrontmatter.image as any} 
                            alt={finalFrontmatter.title} 
                            width={1200} 
                            height={675}
                            class="w-full h-auto object-cover max-h-[600px]" 
                            loading="eager"
                        />
                    )}
                </div>
            )}
            
            {/* RENDER ISI KONTEN */}
            <div class="prose prose-coffee max-w-none">
                {postFromTurso ? (
                    /* RENDER HTML DARI TURSO */
                    <div set:html={postFromTurso.content_html} />
                ) : (
                    /* RENDER MARKDOWN LOKAL */
                    DynamicContent && <DynamicContent />
                )}
            </div>
        </div>
    </ArticleLayout>
) : (
    /* JIKA SLUG TIDAK DITEMUKAN DI MANAPUN */
    <BaseLayout title="404 Not Found">
        <Error404 />
    </BaseLayout>
)}