---
export const prerender = true;
import { getCollection, render } from 'astro:content'; 
import ArticleLayout from '../layouts/ArticleLayout.astro';
import PortableVisualBlocks from '../components/PortableVisualBlocks.astro';
import { getTursoPosts } from '../lib/turso';

export async function getStaticPaths() {
    // Ambil Post Lokal
    const localPosts = await getCollection('blog');
    const localPaths = localPosts.map(post => ({
        params: { slug: (post.slug || post.id).trim() }, 
        props: { post, isExternal: false }
    }));

    // Ambil Post Turso
    let tursoPosts: any[] = []; 
    try {
        tursoPosts = await getTursoPosts();
    } catch (e) {
        console.error("Gagal ambil Turso:", e);
    }
    
    const tursoPaths = tursoPosts.map(post => ({
        params: { slug: String(post.slug || '').trim() },
        props: { post, isExternal: true }
    }));

    return [...localPaths, ...tursoPaths];
}

const { post, isExternal } = Astro.props;
if (!post) return Astro.redirect('/404');

let finalFrontmatter: any;
let DynamicContent: any = null; 
let visualData: any = null;

if (isExternal) {
    // 1. DATA UNTUK FEATURED IMAGE (BANNER ATAS)
    const featuredImage = post.r2_image_url;
    const featuredImageRef = post.sanity_ref || post.mainImage?.asset?._ref;

    finalFrontmatter = {
        title: post.title,
        description: post.description,
        image: featuredImage,
        author: post.author || 'Admin',
        pubDate: post.published_at,
        isExternal: true
    };
    
    // 2. AMBIL DAN FILTER KONTEN BODY
    try {
        const rawContent = typeof post.visual_content === 'string' 
            ? JSON.parse(post.visual_content) 
            : post.visual_content;

        // FILTER: Buang Judul H1 dan Buang Gambar yang sama dengan Banner
        visualData = rawContent.filter((block: any) => {
            if (block.style === 'h1') return false; // Hapus Judul Double

            const blockImageRef = block.asset?._ref;
            if (block._type === 'image' && blockImageRef === featuredImageRef) {
                return false; // Hapus Gambar Double (jika ID-nya sama dengan banner)
            }
            return true;
        });
    } catch (e) { visualData = []; }

} else {
    // Logic untuk Markdown Lokal
    finalFrontmatter = { ...post.data, isExternal: false };
    const rendered = await render(post);
    DynamicContent = rendered.Content; 
}
---

<ArticleLayout frontmatter={finalFrontmatter}>
    <div class="bg-white p-6 md:p-12 my-8 rounded-none border-none shadow-sm">
        
        {finalFrontmatter.image && (
            <div class="mb-12">
                <img 
                    src={finalFrontmatter.image} 
                    alt={finalFrontmatter.title} 
                    class="w-full aspect-video object-cover rounded-none border-b-8 border-[#4a3728]"
                />
            </div>
        )}

        <div class="prose max-w-none">
            {isExternal ? (
                /* BODY CONTENT (Hasil filter tadi) */
                <PortableVisualBlocks value={visualData} />
            ) : (
                DynamicContent && <DynamicContent />
            )}
        </div>
    </div>
</ArticleLayout>