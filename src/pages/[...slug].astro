---
// src/pages/[...slug].astro
export const prerender = true; // GANTI KE TRUE!

import { getCollection, render } from 'astro:content'; 
import { Image } from 'astro:assets'; 
import BaseLayout from '../layouts/BaseLayout.astro';
import ArticleLayout from '../layouts/ArticleLayout.astro';
import Error404 from '../components/Error404.astro';
import { getTursoPosts } from '../lib/turso'; // Pakai fungsi fetch yang sudah kita buat

// 1. FUNGSI WAJIB UNTUK MODE STATIC
export async function getStaticPaths() {
    // Ambil data lokal
    const localPosts = await getCollection('blog');
    const localPaths = localPosts.map(post => ({
        params: { slug: post.id || post.slug },
        props: { post, isExternal: false }
    }));

    // Ambil data Turso
    let tursoPosts = [];
    try {
        tursoPosts = await getTursoPosts();
    } catch (e) {
        console.error("Gagal ambil Turso saat build paths:", e);
    }
    
    const tursoPaths = tursoPosts.map(post => ({
        params: { slug: post.slug },
        props: { post, isExternal: true }
    }));

    return [...localPaths, ...tursoPaths];
}

const { post, isExternal } = Astro.props;
const { slug } = Astro.params;

let DynamicContent: any = null; 
let allHeadings: any[] = []; 

if (!isExternal) {
    // JIKA LOKAL
    const rendered = await render(post);
    DynamicContent = rendered.Content; 
    allHeadings = rendered.headings; 
}

// 2. MAPPING DATA
const finalFrontmatter = isExternal 
    ? {
        title: post.title,
        description: post.description,
        pubDate: post.pubDate,
        author: post.author || "Admin",
        image: post.image,
        isExternal: true 
    } 
    : {
        ...post.data,
        isExternal: false
    };
---

{/* Bagian HTML di bawahnya tetap sama seperti kodingan abang */}
<ArticleLayout frontmatter={finalFrontmatter as any} headings={allHeadings}>
    <div class="bg-white p-8 md:p-12 rounded-[2rem] shadow-sm border border-slate-100 min-h-[500px] my-8">
        {/* Konten gambar dan isi... */}
        <div class="prose prose-coffee max-w-none">
            {isExternal ? (
                <div set:html={post.body} />
            ) : (
                DynamicContent && <DynamicContent />
            )}
        </div>
    </div>
</ArticleLayout>
