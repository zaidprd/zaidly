---
export const prerender = true;
import { getCollection, render } from 'astro:content'; 
import BaseLayout from '../layouts/BaseLayout.astro';
import ArticleLayout from '../layouts/ArticleLayout.astro';
import Error404 from '../components/Error404.astro';
import { getTursoPosts } from '../lib/turso';

export async function getStaticPaths() {
    // 1. Ambil data lokal (.md / .mdx)
    const localPosts = await getCollection('blog');
    const localPaths = localPosts.map(post => ({
        // Membersihkan slug dari ekstensi file .md/.mdx
        params: { 
            slug: (post.slug || post.id).replace(/\.(md|mdx)$/, '') 
        }, 
        props: { post, isExternal: false }
    }));

    // 2. Ambil data Sanity (via Turso)
    let tursoPosts: any[] = []; 
    try {
        tursoPosts = await getTursoPosts();
    } catch (e) {
        console.error("Turso error:", e);
    }
    
    const tursoPaths = tursoPosts.map(post => ({
        params: { slug: String(post.slug).trim() },
        props: { post, isExternal: true }
    }));

    return [...localPaths, ...tursoPaths];
}

const { post, isExternal } = Astro.props;

if (!post) return Astro.redirect('/404');

// PENYIAPAN DATA UNTUK LAYOUT
let finalFrontmatter;
let DynamicContent: any = null; 
let allHeadings: any[] = []; 

if (isExternal) {
    // JALUR ARTIKEL SANITY (Data dari Turso/R2)
    finalFrontmatter = {
        title: post.title,
        description: post.description || '',
        image: post.r2_image_url, 
        author: post.author || 'Zaidly Team',
        pubDate: post.created_at,
        isExternal: true
    };
} else {
    // JALUR ARTIKEL LOKAL (Data dari .md/.mdx)
    finalFrontmatter = {
        ...post.data,
        isExternal: false
    };
    const rendered = await render(post);
    DynamicContent = rendered.Content; 
    allHeadings = rendered.headings; 
}
---

<ArticleLayout frontmatter={finalFrontmatter as any} headings={allHeadings}>
    {/* CONTAINER PUTIH BERSIH - STYLE BEANHUB */}
    <div class="bg-white p-6 md:p-12 rounded-[2rem] shadow-sm border border-slate-100 min-h-[500px] my-8">
        <div class="prose prose-coffee max-w-none prose-img:rounded-xl">
            {isExternal ? (
                /* Render HTML untuk Sanity */
                <div set:html={post.content_html} />
            ) : (
                /* Render Komponen untuk Lokal */
                DynamicContent && <DynamicContent />
            )}
        </div>
    </div>
</ArticleLayout>