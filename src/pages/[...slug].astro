---
export const prerender = true;
import { getCollection, render } from 'astro:content'; 
import ArticleLayout from '../layouts/ArticleLayout.astro';
import PortableVisualBlocks from '../components/PortableVisualBlocks.astro';
import { getTursoPosts } from '../lib/turso';

export async function getStaticPaths() {
    const localPosts = await getCollection('blog');
    const localPaths = localPosts.map(post => ({
        params: { slug: (post.slug || post.id).trim() }, 
        props: { post, isExternal: false }
    }));

    let tursoPosts: any[] = []; 
    try { tursoPosts = await getTursoPosts(); } catch (e) {}
    
    const tursoPaths = tursoPosts.map(post => ({
        params: { slug: String(post.slug || '').trim() },
        props: { post, isExternal: true }
    }));
    return [...localPaths, ...tursoPaths];
}

const { post, isExternal } = Astro.props;
if (!post) return new Response(null, { status: 404 });

// Fungsi standarisasi slug (Wajib sama di semua file)
const getSlug = (str: string) => str.toLowerCase()
    .replace(/[^\w\s-]/g, '')
    .trim()
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-');

let finalFrontmatter: any;
let DynamicContent: any = null;
let visualData: any = null;
let headings: any[] = [];

if (isExternal) {
    const postTags = typeof post.tags === 'string' ? JSON.parse(post.tags) : (post.tags || []);
    finalFrontmatter = { 
        title: post.title, 
        image: post.r2_image_url, 
        author: post.author || 'Admin',
        pubDate: post.published_at,
        tags: postTags,
        slug: post.slug,
        rating: post.rating, 
        price: post.price,
        isExternal: true 
    };
    visualData = typeof post.visual_content === 'string' ? JSON.parse(post.visual_content) : post.visual_content;
    
    // --- PENYEMPURNAAN DETEKSI HEADINGS (MARKDOWN & SANITY) ---
    headings = (visualData || []).flatMap((block: any) => {
        const rawText = block.children?.map((c: any) => c.text).join('') || '';
        const isSanityHeading = /^h[1-6]$/.test(block.style || '');
        
        // 1. Tangkap heading resmi dari dropdown Sanity (H2, H3, dst)
        if (isSanityHeading) {
            const depth = parseInt(block.style.replace('h', ''));
            return [{ depth, text: rawText, slug: getSlug(rawText) }];
        } 
        
        // 2. Scan blok Normal untuk mencari simbol ## dan ### secara baris-demi-baris
        const lines = rawText.split('\n');
        const extracted: any[] = [];
        
        lines.forEach(line => {
            const match = line.match(/^(#{2,3})\s+(.*)/);
            if (match) {
                const depth = match[1].length;
                const text = match[2].replace(/\*\*/g, '').trim(); // Bersihkan bold stars
                extracted.push({ depth, text, slug: getSlug(text) });
            }
        });

        return extracted;
    });
} else {
    finalFrontmatter = { ...post.data, isExternal: false };
    const rendered = await render(post);
    DynamicContent = rendered.Content; 
    
    // Sinkronkan Headings Lokal
    headings = rendered.headings.map((h: any) => ({
        ...h,
        slug: getSlug(h.text)
    }));
}
---

<ArticleLayout frontmatter={finalFrontmatter} headings={headings}>
    <div class="prose max-w-none zaidly-content">
        {isExternal ? (
            <PortableVisualBlocks value={visualData} />
        ) : (
            <div class="local-article-fix">
                {DynamicContent && <DynamicContent />}
            </div>
        )}
    </div>
</ArticleLayout>
